#!/bin/sh
#
# upcsub -n NxP exe args

subname=upcsub
which_script=/share/cs-instructional/cs5220/local/upc/etc/upcscript
source /share/cs-instructional/cs5220/local/etc/subbasement.sh

NPROCESS=`echo $NP | sed 's/[0-9]*x//'`
NPTHREAD=`echo $NP | sed 's/x[0-9]*//'`
if [ -z "$NPROCESS" ] ; then
  NPROCESS=1
fi
if [ -z "$NPTHREAD" ] ; then
  NPTHREAD=1
fi

echo "Processes: $NPROCESS"
echo "Threads per: $NPTHREAD"
NTHREAD=$[ $NPROCESS * $NPTHREAD ]
echo "Threads total: $NTHREAD"

cat <<EOF > $SUBFILE
# HTCondor script generated by $subname
universe = parallel
executable = $which_script
getenv = true
arguments = `pwd` $NTHREAD $hast $EXE $@
#should_transfer_files = yes
#when_to_transfer_output = on_exit_or_evict
output = $BASENAME-o.\$(NODE)
error  = $BASENAME-e.\$(NODE)
log    = $BASENAME-l
notification = never
request_cpus = $NPTHREAD
machine_count = $NPROCESS
EOF

write_reqs
echo "queue" >> $SUBFILE

if [ -z "$hasd" ]; then
  condor_submit $SUBFILE
fi
