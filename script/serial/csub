#!/bin/sh
#
# csub -n np exe args

if [ $# -lt 1 ]; then
  echo "Usage: csub [-n procs] [-a] [-t opts] [-f script] exe args"
  echo "  -n -- determines number of processes to launch (default 1)"
  echo "  -a -- use whole cluster (vs just instructional nodes)"
  echo "  -t -- use TAU to profile"
  echo "  -f -- specify additional HTCondor features"
  exit 0
fi

done_parsing=false
which_script=/share/cs-instructional/cs5220/local/etc/csubscript
NP=1
hasa=""
hast=""
hasf=""

while [ $done_parsing = "false" ]
do
done_parsing=true

if [ "$1" = "-n" ]; then
  shift
  NP=$1
  shift
  done_parsing=false
fi

if [ "$1" = "-a" ]; then
  shift
  hasa=true
  done_parsing=false
fi

if [ "$1" = "-t" ]; then
  shift
  hast="tau_exec $1"
  shift
  export TAU_VERBOSE=1
  export PROFILEDIR="."
  done_parsing=false
fi

if [ "$1" = "-f" ]; then
  shift
  hasf=$1
  shift
  done_parsing=false
fi

done

SUBFILE=csub-$$.sub

cat <<EOF > $SUBFILE
# HTCondor script generated by csub
universe = vanilla
executable = $which_script
getenv = true
arguments = "$hast $@"
notification = never

EOF

if [ -z "$hasa" ]; then
  echo 'requirements = C4_GROUP == "cs"' >> $SUBFILE
fi

if [ "$hasf" ]; then
  cat $hasf >> $SUBFILE
fi

for job in `seq 1 $NP` ; do
let jobid=job-1
cat <<EOF >> $SUBFILE

output = csub-$$-o.$jobid
error  = csub-$$-e.$jobid
log    = csub-$$-l.$jobid
queue
EOF
done

condor_submit $SUBFILE
