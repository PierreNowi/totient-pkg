#!/bin/sh
#
# mpisub -n np exe args

subname=mpisub
which_script=/share/cs-instructional/cs5220/intel/impi/4.1.1.036/intel64/etc/intelmpiscript
source /share/cs-instructional/cs5220/local/etc/subbasement.sh

split_nproc

# Add explicit path to executables
if EXE=`which $1` ; then
  EXE=`readlink -f $EXE`
else
  echo "Cannot find $EXE"
  exit 0
fi
shift

cat <<EOF > $SUBFILE
# HTCondor script generated by $subname
universe = parallel
executable = $which_script
transfer_executable = false
getenv = true
arguments = $NTHREAD $NPTHREAD $hast $EXE $@
output = $BASENAME-o.\$(NODE)
error  = $BASENAME-e.\$(NODE)
log    = $BASENAME-l
notification = never
machine_count = $NP
EOF

write_reqs
echo "queue" >> $SUBFILE

if [ -z "$hasd" ]; then
  condor_submit $SUBFILE
fi
