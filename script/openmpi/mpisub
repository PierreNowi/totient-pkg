#!/bin/sh
#
# mpisub -n np exe args

subname=mpisub
which_script=$HOME/local/openmpi-1.8.6/etc/openmpiscript
source $HOME/local/etc/subbasement.sh

split_nproc

# Add explicit path to executables
if EXE=`which $1` ; then
  EXE=`readlink -f $EXE`
else
  echo "Cannot find $EXE"
  exit 0
fi
shift

SUBFILE=mpisub-$$.sub

cat <<EOF > $SUBFILE
# HTCondor script generated by $subname
universe = parallel
executable = $which_script
transfer_executable = false
getenv = true
arguments = $NTHREAD $NPTHREAD 1 $hast $EXE $@
output = $BASENAME-o.\$(NODE)
error  = $BASENAME-e.\$(NODE)
log    = $BASENAME-l
notification = never
request_cpus = $NPTHREAD
machine_count = $NPROCESS

# Set max run time
periodic_remove = JobStatus == 2 && \
 ( (CurrentTime - EnteredCurrentStatus) + \
   RemoteWallClockTime - CumulativeSuspensionTime < $MAX_RUN_TIME )

EOF

write_reqs
echo "queue" >> $SUBFILE

if [ -z "$hasd" ]; then
  condor_submit $SUBFILE
fi
