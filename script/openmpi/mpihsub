#!/bin/sh
#
# mpihsub -n np exe args

subname=mpihsub
which_script=$HOME/local/openmpi-1.8.6/etc/openmpiscript
source $HOME/local/etc/subbasement.sh

split_nproc

# Add explicit path to executables
if EXE=`which $1` ; then
  EXE=`readlink -f $EXE`
else
  echo "Cannot find $EXE"
  exit 0
fi
shift

SUBFILE=mpisub-$$.sub

cat <<EOF > $SUBFILE
# HTCondor script generated by $subname
universe = parallel
executable = $which_script
transfer_executable = false
getenv = true
arguments = $NPROCESS 1 $NPTHREAD $hast $EXE $@
output = $BASENAME-o.\$(NODE)
error  = $BASENAME-e.\$(NODE)
log    = $BASENAME-l
notification = never
request_cpus = $NPTHREAD
machine_count = $NPROCESS
EOF

write_reqs
echo "queue" >> $SUBFILE

if [ -z "$hasd" ]; then
  condor_submit $SUBFILE
fi
